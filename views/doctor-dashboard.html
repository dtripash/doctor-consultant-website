<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Doctor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="/css/doctor-dashboard.css" rel="stylesheet">
</head>
<body>

<div class="dashboard-container">
  <!-- Sidebar with profile -->
  <aside class="sidebar">
    <div class="profile-card">
      <div class="profile-avatar">üë®‚Äç‚öïÔ∏è</div>
      <h2 id="doctorName"></h2>
      <p id="doctorSpecialization"></p>
      <p><strong>Experience:</strong> <span id="doctorExperience"></span> years</p>
      <button onclick="logout()" class="logout-btn">Logout</button>
    </div>
  </aside>

  <!-- Main content -->
  <main class="main-content">
    <h1>Patient Reports</h1>
    <div id="reports" class="reports-container"></div>
  </main>
</div>

<script>
// Logout function
function logout() {
  localStorage.removeItem("doctorEmail"); // clear login
  alert("Logged out successfully!");
  window.location.href = "doctor-login.html";
}
// Set profile info dynamically
const doctorProfile = {
  name: "Dr. Shalmali R Basangar",
  specialization: "BHMS, Nutrition [PGDDM]",
  experience: "10+ years",
};

document.getElementById("doctorName").textContent = doctorProfile.name;
document.getElementById("doctorSpecialization").textContent = doctorProfile.specialization;
document.getElementById("doctorExperience").textContent = doctorProfile.experience;

// Ensure logged in
const doctorEmail = localStorage.getItem("doctorEmail");
if(!doctorEmail){
  alert("You must log in first!");
  window.location.href = "doctor-login.html";
}

// Load consultations dynamically
async function loadReports() {
  try {
    const res = await fetch('/api/consultations');
    const reports = await res.json();
    const container = document.getElementById("reports");
    container.innerHTML = "";

    if (!reports.length) {
      container.innerHTML = "<p>No consultations found.</p>";
      return;
    }

    reports.forEach(report => {
      const div = document.createElement("div");
      div.classList.add("report-card");
      div.innerHTML = `
        <p><strong>Patient Email:</strong> ${report.email}</p>
        <p><strong>Problem Type:</strong> ${report.problemType}</p>
        <p><strong>Duration:</strong> ${report.duration}</p>
        <p><strong>Pain:</strong> ${report.pain}</p>
        <p><strong>Consulted:</strong> ${report.consulted}</p>
        <p><strong>Feedback:</strong> <span class="feedback-text">${report.feedback || "Pending"}</span></p>
      `;

      if(report.feedback === 'Pending'){
        const form = document.createElement("form");
        form.classList.add("feedback-form");
        form.innerHTML = `
          <input type="hidden" name="reportId" value="${report._id}">
          <label>Feedback:</label>
          <textarea name="feedback" required></textarea>
          <button type="submit">Submit Feedback</button>
        `;
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const feedback = form.feedback.value.trim();
          if(!feedback) return;

          await fetch('/submit-feedback', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ reportId: report._id, feedback })
          });

          div.querySelector(".feedback-text").textContent = feedback;
          form.remove();
        });
        div.appendChild(form);
      }

      container.appendChild(div);
    });

  } catch (err) {
    console.error(err);
  }
}

loadReports();
setInterval(loadReports, 30000); // refresh every 30s

</script>

</body>
</html>
